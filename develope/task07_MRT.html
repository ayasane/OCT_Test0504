<!DOCTYPE html>
<html>
  <head>
      <title>VOLT experiment</title>
      <script src="src/jspsych-6.1.0/jspsych.js"></script>
      <script src="src/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
      <script src="src/jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
      <script src="src/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
      <script src="src/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
      <script src="src/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
      <link rel="stylesheet" href="src/jspsych-6.1.0/css/jspsych.css"></link>
  </head>

<body>
    <script type="text/javascript">

      /* 課題に関するコードを以下に書く */
      var fullscreen = {
        type: 'fullscreen',
        message: '<p>以下のボタンをクリックすると，画面は全画面表示に切り替わります。全画面表示を止めたい場合はEscキーを押してください。</p>',
        button_label: "全画面表示に切り替え",
        fullscreen_mode: true
      };


      var welcome = {
        type: "html-button-response",
        stimulus: 'マトリックス推論課題'+
        '<br><br>図形全体を完成させるために最適なパーツを選ぶ課題です。' +
        '<br>選択には数字キーを押します。' +
        '<br><br>時間制限はありません。自分のペースで進めてください。'+
        '<br><br>次のページから課題が始まります。',
        choices: ['次へ']
      };

/*
参考URL: https://www.jspsych.org/overview/timeline/
timelineVariable の２つ目の引数について：　https://www.jspsych.org/core_library/jspsych-core/
*/

/*
3回続けて間違うと課題が終了するようにrepfalseを入れる？それとも全部やらせる？？
（途中で終了する場合は，全１１問，という表示を変更する必要がある）
*/
      var sumcorrect = 0;
      var repfalse = 0;
      var Ntrial = 0;
      var test_procedure = {
          timeline: [
              {
                  type: 'html-keyboard-response',
                  stimulus: '+',
                  choices: jsPsych.NO_KEYS,
                  trial_duration: 500
              },
              {
                  type: 'image-keyboard-response',
                  stimulus: jsPsych.timelineVariable('stim'),
                  stimulus_height:600,
                  choices: ['1','2','3','4','5','6','7','8'],
                  correct: jsPsych.timelineVariable('correct'),
                  data: {
                    correct_response: jsPsych.timelineVariable('correct_response')
                  },
                  prompt: '<br><b>上部の図形を完成させるために「？」に入れる最適なパーツを下の選択肢から選び、'+
                  '<br>キーボードの対応する数字キーを押して下さい。</b>',
                  on_finish: function(data){
                    data.correct = jsPsych.pluginAPI.compareKeys(data.key_press, data.correct_response);
                    Ntrial = Ntrial + 1;
                    if(data.correct == 1){
                      sumcorrect = sumcorrect + 1;
                      repfalse = 0;
                    } else {
                      repfalse = repfalse + 1;
                    };
                  }
              }
          ],
          timeline_variables: [
              { stim: 'img/task07_MRT/vfig12043.JPG', correct_response: '4'},
              { stim: 'img/task07_MRT/vfig12044.JPG', correct_response: '3'},
              { stim: 'img/task07_MRT/vfig12045.JPG', correct_response: '5'},
              { stim: 'img/task07_MRT/vfig12046.JPG', correct_response: '2'},
              { stim: 'img/task07_MRT/vfig12047.JPG', correct_response: '2'},
              { stim: 'img/task07_MRT/vfig12048.JPG', correct_response: '4'},
              { stim: 'img/task07_MRT/vfig12050.JPG', correct_response: '5'},
              { stim: 'img/task07_MRT/vfig12053.JPG', correct_response: '3'},
              { stim: 'img/task07_MRT/vfig12054.JPG', correct_response: '1'},
              { stim: 'img/task07_MRT/vfig12055.JPG', correct_response: '4'},
              { stim: 'img/task07_MRT/vfig12056.JPG', correct_response: '5'},
          ],
          randomize_order: false,
          conditional_function: function () {
            if (repfalse > 2) {
              return false;
            } else {
              return true;
            }
          },
      };

      var final_page = {
        type: "html-button-response",
        stimulus: function(){
          return 'お疲れ様でした！'+
          '<br><br>全' + Ntrial + '問中 ' + sumcorrect + ' 問正解でした。<br><br>'
        },
        choices: ['終わる'],
      };

      /* タイムラインの設定 */

      var timeline = [];
      timeline.push(fullscreen);
      timeline.push(welcome);
      timeline.push(test_procedure,final_page);

      /* 課題開始 */
      jsPsych.init({
        timeline: timeline,
        on_finish: function() {
          jsPsych.data.displayData();
        }
      });

    </script>
</body>
</html>
