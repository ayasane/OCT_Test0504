<!DOCTYPE html>
<html>
  <head>
    <title>BART experiment</title>
    <script src="src/jspsych-6.1.0/jspsych.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="src/jspsych-psychophysics.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <link href="src/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>

  <script>

  var Ins_block = {
    type: 'instructions',
    pages: [
      'これから３０個の風船が１個ずつ画面に表示されます。'+
      '<br><b>【膨らます】ボタン</b> をクリックすると、風船が膨らみます。'+
      '<br>ボタンをクリックする度に、風船は少しずつ膨らみますが、<u>膨らましすぎると破裂します。</u>'+
      '<br><br>それぞれの風船を何回膨らますかは、あなた次第です。１回膨らますだけで破裂する風船もあるかもしれませんし、画面いっぱいまで膨らませる風船もあるかもしれません。'+
      '<br><br>この課題では、風船を膨らます毎に<b>５ポイント</b>を一時的に獲得できます（<b>一時的獲得額</b>）。'+
      '<br>しかし、<u>風船が割れると、その風船の一時的獲得額は０</u>になります。' +
      '<br><br>風船が割れる前に一時的獲得額受け取るには、 <b>【今の金額で回収】ボタン</b>を押して下さい。一時獲得額が，合計獲得額に加算されます。'+
      '<br>このボタンを押すか、もしくは風船が割れると、次の新しい風船が現れます。'+
      '<br><br>課題の最後に、合計で獲得された金額に応じて謝礼が支払われます。',
      '下記は、この課題の概要をまとめます。<b>'+
      '<br><br>※ 風船を膨らます毎に５ポイントを一時的に獲得できます。'+
      '<br>※ ただし、風船が割れると、その風船の一時的獲得額は０になります。' +
      '<br>※ 課題中に出てくる風船は３０個です。' +
      '<br>※ 風船によって、割れるまでの回数は異なります。' +
      '<br>※ 最後に合計獲得額に応じて謝金に上乗せがあります。</b>' +
      '<br><br><br>それでは次のページから本番です！<br>（この課題では音がなります。）'],
    show_clickable_nav: true,
    button_label_previous:'戻る',
    button_label_next: '次へ',
  }

  var pointTotal = 0;
  var pointPotential = 0;
  var pump_count = 0;
  var bulloon_condition = 0;
  var trialNum = 1;
  var size = 0.08;//0.2;

  var sounds = {
      obj_type: 'sound', // means a rectangle
      file: '',
  }

  var Text_summary = {
    type: 'psychophysics',
    stimuli: [{obj_type: 'image',
                file: 'img/task09_BART/balloon1.jpg',
                scale: 0.1,
                startX: 500,
                startY: 560,//400,
                //width: 4,
                //height:5,
              },sounds],
    //stimulus: 'img/task09_BART/balloon1.jpg',

    response_type: 'button',
    button_choices: ['膨らます','今の金額で回収'],
    canvas_width: 1000,
    canvas_height: 610,//500
    background_color: 'white',
    prompt: function(){
      return '<div align="left">' +
      '<p>風船： ' + trialNum + " 個目（全30個）</p>" +
      "<p><b>一時的獲得額： " + pointPotential + "ポイント</b>" +
      "　（膨らました回数：　" + pump_count + "回）</p>" +
      "<p><b>合計獲得額：　" + pointTotal + "ポイント</b></p></div>"
    },
    response_ends_trial: true,
    on_start: function(Text_summary){
      Text_summary.stimuli[0].scale = size;
      Text_summary.stimuli[0].startY = 560-2.03*pump_count;//400 - 15/2* pump_count;

      if(pump_count != 0){
        if(bulloon_condition == 0){ // 膨らます
          Text_summary.stimuli[1].file = 'audio/task09_BART/inflate.mp3';
        }

        if(bulloon_condition == 1){ // 割れた
          Text_summary.stimuli[0].file =  'img/task09_BART/balloon2.jpg';
          Text_summary.stimuli[0].startY = 560-2.03*(pump_count-1);//400 - 15/2* (pump_count-1);
          Text_summary.stimuli[1].file = 'audio/task09_BART/explosion.mp3';
        }

        if(bulloon_condition == 2){ // 受け取った
          Text_summary.stimuli[1].file = 'audio/task09_BART/casino.mp3';
        }

        if(bulloon_condition != 0){ // 割れた・受け取った　共通
          Text_summary.trial_duration = 2000;
          Text_summary.response_start_time = 3000;
          Text_summary.button_choices =['ーーーー','ーーーーーーー'];
        }
      }

      if(pump_count == 0 & bulloon_condition == 2){ //ふくらまさずに受け取った場合
        Text_summary.stimuli[1].file = 'audio/task09_BART/casino.mp3';
        Text_summary.trial_duration = 2000;
        Text_summary.response_start_time = 3000;
        Text_summary.button_choices =['ーーーー','ーーーーーーー'];
      }
    },
    on_end: function(Text_summary){
      Text_summary.stimuli[0].file =  'img/task09_BART/balloon1.jpg';
      Text_summary.trial_duration = 200000000000;
      Text_summary.button_choices =['膨らます','今の金額で回収'];
    },
  }

  var Trial = {
    timeline: [Text_summary],
    loop_function: function(data,Trial){
      if(data.values()[0].button_pressed == 0){
        pump_count += 1;
        if(Math.random() <= 1/(128-pump_count+1)){//上限に達した時
        //if(pump_count == balloon_max[(trialNum-1)] ){
          bulloon_condition = 1;
          pointPotential = 0;
          return true;
        } else {
          //jsPsych.data.addDataToLastTrial({banked: true});
          size += 0.0048;
          pointPotential += 5;
          return true;
        }
      } else if(data.values()[0].button_pressed == 1) {//途中でやめた
        bulloon_condition = 2;
        pointTotal += pointPotential;
        return true;
      } else {
        pump_count = 0;
        bulloon_condition = 0;
        pointPotential = 0;
        size = 0.08;
        trialNum += 1;
        return false;
      }
    },
    on_finish: function(data){
      if(bulloon_condition != 0){//破裂か受け取った時だけ，下記を記録する。
        data.Ntrial = trialNum;
        data.pump_count = pump_count;
        data.balloon_condition = bulloon_condition; // 1:破裂, 2:受け取り
      }
    },
  };

  //var balloon_max = [5,25,15,4];

  var TestProcedure = {
    timeline: [Trial],
    //timeline_variables: balloon_max,
    //randomize_order: false,
    repetitions: 30
  }

  var final_page = {
    type: "html-button-response",
    stimulus: function(){
      return 'お疲れ様でした！'+
      '<br><br>合計獲得額は、' + pointTotal + ' ポイントでした。<br><br>'
    },
    choices: ['終わる'],
  };

  var timeline = [];
  timeline.push(Ins_block,TestProcedure,final_page);

  var images = ['img/task09_BART/balloon1.jpg', 'img/task09_BART/balloon2.jpg'];
  var audio = ['audio/task09_BART/casino.mp3', 'audio/task09_BART/explosion.mp3','audio/task09_BART/inflate.mp3'];

  jsPsych.init({
    timeline: timeline,
    //use_webaudio: false,
    preload_audio: audio,
    preload_images: images,

    on_finish: function() {
	    jsPsych.data.displayData();
	  }
  });

  </script>
</html>
