<!DOCTYPE html>
<html>
<head>
    <script src="src/jspsych-6.1.0/jspsych.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="src/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="src/jspsych-psychophysics-2.0/jspsych-psychophysics.js"></script>
    <link rel="stylesheet" href="src/jspsych-6.1.0/css/jspsych.css"></link>
</head>

<body bgcolor="#FFF", text="#000">
    <script type="text/javascript">

      /* 課題に関するコードを以下に書く */
      var fullscreen = {
        type: 'fullscreen',
        message: '<p>以下のボタンをクリックすると，画面は全画面表示に切り替わります。全画面表示を止めたい場合はEscキーを押してください。</p>',
        button_label: "全画面表示に切り替え",
        fullscreen_mode: true
      };
      var instruction_1 = {
        type: "html-keyboard-response",
        stimulus: "これから画面上に赤色と青色の線が，異なった角度で出てきます。<br>赤色の線と同じ角度になるように，青色の線を回転させて調整してください。<br><br>青色の線は，「右」ボタンをクリックすると右回転，「左」ボタンをクリックすると左回転します。<br>赤色の線と同じ角度になったと思ったら，「終了」ボタンをクリックしてください。<br><br>それでは，練習をします。<br>用意ができたら，キーボードのキーをどれか押して始めてください。"
      };

      /* タイムラインの設定 */
      var timeline = [];
      /* timeline.push(fullscreen); */
      timeline.push(instruction_1);

      var line_blue_p = {
        obj_type: 'line',
        startX: 800, // location in the canvas
        startY: 400,
        angle:  60,
        line_length: 200,
        line_width: 3,
        line_color: 'blue'
      }

      var line_red_p = {
        obj_type: 'line',
        startX: 200, // location in the canvas
        startY: 400,
        angle:  24,
        line_length: 200,
        line_width: 3,
        line_color: 'red'
      }

      /* 回転の教示 */
      var text_rotate = {
       obj_type: 'text',
       startX: 120,
       startY: 680,
       content: '青い線を回転させるために\nボタンを押してください',
       font: "16px 'Arial'",
       text_color: 'black'
      }

      /* 終了の教示 */
      var text_finish = {
       obj_type: 'text',
       startX: 880,
       startY: 680,
       content: '２つの線の方向が同じになったら\n「終了」を押してください',
       font: "16px 'Arial'",
       text_color: 'black',
      }

      var trial_p = {
          type: 'psychophysics',
          response_type: 'button',
          stimuli: [line_blue_p,line_red_p,text_rotate,text_finish],
          button_choices: ['<div style="position: absolute; top: 80%; right: 62%"><img src="img/task05_LOT/img_left.png" width="100px"/></div>',
          '<div style="position: absolute; top: 80%; right: 47%"><img src="img/task05_LOT/img_fin.png" width="100px"/></div>',
          '<div style="position: absolute; top: 80%; right: 32%"><img src="img/task05_LOT/img_right.png" width="100px"/></div>'],
          button_html:  '<button class="jspsych-btn">%choice%</button>',
          canvas_width: 1000,
          canvas_height: 800,
          background_color: "white",
          on_finish: function(data){
            data.blue_angle = line_blue_p.angle;
            data.blue_length = line_blue_p.line_length;
            data.blue_X = line_blue_p.startX;
            data.blue_Y = line_blue_p.startY;
            data.red_angle = line_red_p.angle;
            data.red_length = line_red_p.line_length;
            data.red_X = line_red_p.startX;
            data.red_Y = line_red_p.startY;
            if(data.red_angle == data.blue_angle || data.red_angle == 180-data.blue_angle){
              data.correct_response = 1;
            }else{
              data.correct_response = 0;
            }
          }
      }

      /* practice 1*/
      var practice1 = {
        timeline: [trial_p],
        loop_function: function(){
          var last_select = jsPsych.data.get().last(1).values()[0].button_pressed;
          if(last_select == "2"){
              /* メモ：回転の段階で180を越えていたら0にリセットする，回転の結果180越えても0にリセットする*/
            if(line_blue_p.angle == 180){
              line_blue_p.angle = 0;
            }
            line_blue_p.angle = line_blue_p.angle + 6;
            if(line_blue_p.angle == 180){
              line_blue_p.angle = 0;
            }
            return true;
          } else if(last_select == "0"){
              /* メモ：回転の段階で0以下だったら0にリセットする，回転の結果0以下でも0にリセットする*/
            if(line_blue_p.angle == 0){
              line_blue_p.angle = 180;
            }
            line_blue_p.angle = line_blue_p.angle - 6;
            if(line_blue_p.angle == 0){
              line_blue_p.angle = 180;
            }
            return true;
          } else {
              return false;
          }
        },
      };
      timeline.push(practice1);

      var instruction_2 = {
        type: "html-keyboard-response",
        stimulus: "取り組んでいただく内容は理解いただけましたでしょうか？<br><br>「右」か「左」のボタンをクリックして，青色の線を回転させて，赤色の線と同じ角度にしてください。<br>赤色の線と同じ角度になったと思ったら，「終了」ボタンをクリックしてください。<br><br>本番に進んで良いようでしたらスペースキーを押してください。",
      };
      timeline.push(instruction_2);

      /* In R
      # angle
      angle_red <- sample(c(6, 24, 36, 54, 66, 84, 96, 114, 126, 144, 156, 174))
      angle_blue <- sample(c(6, 24, 36, 54, 66, 84, 96, 114, 126, 144, 156, 174))
      # most efficient solution
      abs(ifelse(angle_red > 90, 180 - angle_red, angle_red) - ifelse(angle_blue > 90, 180 - angle_blue, angle_blue))/6
      # length of blue
      sample(c(100, 100, 100, 100, 50, 50, 50, 50, 25, 25, 25, 25))
      */
      var line_red_angle   = [174, 84,  36,  96, 156, 114, 24, 126,  66,  6,  54, 144];
      var line_blue_angle  = [24,   6,  54, 126,  96, 174, 84, 156, 144, 66, 114,  36];
      var line_blue_length = [100, 25, 100,  50, 100, 100, 25,  50,  50, 25,  25,  50];
                         /*1   3    4    2    4    2    3    1    2    4    3    1 ＜1=水平下,2=水平上,3=対角青右下,4=対角青右上＞*/
      var line_blue_x = [800, 724, 724, 800, 724, 800, 724, 800, 800, 724, 724, 800];
      var line_blue_y = [400, 500, 150, 200, 100, 150, 550, 400, 150, 100, 550, 450];
      var line_red_x =  [200, 276, 276, 200, 276, 200, 276, 200, 200, 276, 276, 200];
      var line_red_y =  [400, 100, 550, 200, 500, 150, 150, 400, 150, 500, 150, 450];
      var trial_n = 12;
      var trial_i = 0;

      var line_blue = {
        obj_type: 'line',
        startX: line_blue_x[0],
        startY: line_blue_y[0],
        angle:  line_blue_angle[0],
        line_length: line_blue_length[0],
        line_width: 3,
        line_color: 'blue'
      }

      var line_red = {
        obj_type: 'line',
        startX: line_red_x[0],
        startY: line_red_y[0],
        angle:  line_red_angle[0],
        line_length: 100,
        line_width: 3,
        line_color: 'red'
      }

      var trial = {
          type: 'psychophysics',
          response_type: 'button',
          stimuli: [line_blue,line_red,text_rotate,text_finish],
          button_choices: ['<div style="position: absolute; top: 80%; right: 62%"><img src="img/task05_LOT/img_left.png" width="100px"/></div>',
          '<div style="position: absolute; top: 80%; right: 47%"><img src="img/task05_LOT/img_fin.png" width="100px"/></div>',
          '<div style="position: absolute; top: 80%; right: 32%"><img src="img/task05_LOT/img_right.png" width="100px"/></div>'],
          button_html:  '<button class="jspsych-btn">%choice%</button>',
          canvas_width: 1000,
          canvas_height: 800,
          background_color: "white",
          on_finish: function(data){
            data.blue_angle = line_blue.angle;
            data.blue_length = line_blue.line_length;
            data.blue_X = line_blue.startX;
            data.blue_Y = line_blue.startY;
            data.red_angle = line_red.angle;
            data.red_length = line_red.line_length;
            data.red_X = line_red.startX;
            data.red_Y = line_red.startY;
            if(data.red_angle == data.blue_angle || data.red_angle == 180-data.blue_angle){
              data.correct_response = 1;
            }else{
              data.correct_response = 0;
            }
          }
      }

      /* trial 1*/
      for(var i = 0; i < trial_n; i++) {
        var lot = {
          timeline: [trial],
          loop_function: function(){
            var last_select = jsPsych.data.get().last(1).values()[0].button_pressed;
            if(last_select == "2"){
              if(line_blue.angle == 180){
                line_blue.angle = 0;
              }
              line_blue.angle = line_blue.angle + 6;
              if(line_blue.angle == 180){
                line_blue.angle = 0;
              }
              return true;
            } else if(last_select == "0"){
              if(line_blue.angle == 0){
                line_blue.angle = 180;
              }
              line_blue.angle = line_blue.angle - 6;
              if(line_blue.angle == 0){
                line_blue.angle = 180;
              }
              return true;
            } else {
              if(trial_i < trial_n){
                trial_i = trial_i +1;
                line_blue.angle = line_blue_angle[trial_i];
                line_blue.line_length = line_blue_length[trial_i];
                line_blue.startX = line_blue_x[trial_i];
                line_blue.startY = line_blue_y[trial_i];
                line_red.angle = line_red_angle[trial_i];
                line_red.startX = line_red_x[trial_i];
                line_red.startY = line_red_y[trial_i];
                return false;
              }
                return false;
            }
          },

        };
        timeline.push(lot);
      }

      var instruction_end = {
        type: "html-keyboard-response",
        stimulus: "課題は終了です。お疲れ様でした。"
      };
      timeline.push(instruction_end);

      /* 課題開始 */
      jsPsych.init({
        timeline: timeline,
        on_finish: function() {
          jsPsych.data.displayData();
        }
      });

    </script>
</body>
</html>
